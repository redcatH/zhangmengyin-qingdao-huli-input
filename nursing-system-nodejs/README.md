# 护理入住登记系统 - Node.js重构版本

## 🎯 项目概述

这是原护理入住登记系统的Node.js重构版本，采用现代化的模块化设计，大大提升了代码的可维护性、可读性和可扩展性。

## 📁 项目结构

```
nursing-system-nodejs/
├── src/                          # 源代码目录
│   ├── main.js                  # 主程序入口
│   ├── config.js                # 配置管理
│   ├── logger.js                # 日志管理
│   ├── dataManager.js           # 数据管理
│   ├── personnelManager.js      # 人员管理
│   ├── apiClient.js             # API客户端
│   └── nursingProcessor.js      # 业务处理器
├── config.json                  # 配置文件
├── package.json                 # 项目依赖
├── run.bat                      # 一键运行脚本
└── README.md                    # 使用说明
```

## 🚀 快速开始

### 环境要求
- Node.js 16.0 或更高版本
- npm 包管理器
- Windows 操作系统（run.bat脚本）

### 方法1: 一键运行（推荐）
```bash
# 双击运行
run.bat
```

### 方法2: 手动运行
```bash
# 1. 进入项目目录
cd nursing-system-nodejs

# 2. 安装依赖
npm install

# 3. 将Excel文件复制到当前目录
# 确保文件名与config.json中配置的一致

# 4. 运行系统
node src/main.js

# 5. 使用自定义配置
node src/main.js --config my-config.json
```

## ⚙️ 系统配置

所有配置都在 `config.json` 文件中，无需修改代码：

```json
{
  "api": {
    "baseUrl": "http://test.vssh.top/api/rest",
    "token": "SESSION=...",
    "timeout": 30000
  },
  "files": {
    "excelFile": "入住表（刘毅用）9月.xls",
    "nurseFile": "nurseObjs.json",
    "doctorFile": "doctorObjs.json",
    "caregiverFile": "caregiverObjs.json",
    "successFile": "successfulUsers.json",
    "errorLog": "error.log"
  },
  "personnel": {
    "nursesLimit": 50,
    "doctorsLimit": 80,
    "caregiversLimit": 30
  },
  "specificCaregivers": [
    "张梅", "卢秀萍", "刘建贞", "刘同花", "刘同秀", "刘岩",
    "刘俊伟", "薛红", "薛光艳", "刘艳华", "薛玉英", "郎庆芳",
    "郭爱辉", "泮瑞英", "王甜甜", "于永香", "倪晓光", "营亮平",
    "王洁", "张本文", "刘香", "殷玉庆"
  ],
  "nursingItemIndices": [0, 1, 9, 11, 13, 14, 15, 22, 27, 28, 29, 58],
  "retry": {
    "maxRetries": 3,
    "delay": 1000
  },
  "logging": {
    "level": "info",
    "enableConsole": true,
    "enableFile": true
  }
}
```

## 🏗️ 架构设计

### 模块化架构

#### 1. **Config** - 配置管理
- 统一管理所有配置参数
- 支持外部配置文件和默认配置
- 支持点分隔路径访问配置 (`config.get('api.baseUrl')`)

#### 2. **Logger** - 日志管理
- 分级日志输出（error, warn, info, debug）
- 同时输出到控制台和文件
- 统一的日志格式和时间戳

#### 3. **DataManager** - 数据管理
- Excel文件读取和解析
- JSON文件读写操作
- 用户处理状态管理
- 自动生成处理报告

#### 4. **PersonnelManager** - 人员管理
- 智能人员分配算法（负载均衡）
- 人员计数和限制管理
- 护理员特定名单筛选
- 人员统计和状态监控

#### 5. **ApiClient** - API客户端
- 统一的HTTP请求处理
- 自动错误处理和分类
- 请求超时和重试机制
- 健康检查功能

#### 6. **NursingProcessor** - 业务处理器
- 核心业务逻辑实现
- 用户登记流程控制
- 批量处理和进度监控
- 系统预检查功能

## 🎯 核心功能

### 1. 智能人员分配
- **负载均衡**: 优先分配给负责人数较少的人员
- **上限管理**: 自动检测并处理人员达到上限的情况
- **特殊筛选**: 护理员按指定名单筛选
- **实时统计**: 显示人员使用情况和容量

### 2. 容错和恢复
- **断点续传**: 支持中断后继续处理，跳过已成功用户
- **智能重试**: 网络异常和人员冲突自动重试
- **错误分类**: 不同错误类型采用不同处理策略
- **详细日志**: 完整的错误信息和堆栈跟踪

### 3. 监控和报告
- **实时进度**: 显示处理进度和成功率
- **详细统计**: 完整的处理统计信息
- **自动报告**: 自动生成JSON格式的处理报告
- **人员状态**: 实时显示人员分配和使用情况

### 4. 用户体验
- **一键运行**: 自动检查环境、安装依赖、启动系统
- **清晰输出**: 结构化的日志输出和进度显示
- **友好提示**: 详细的错误提示和解决建议
- **优雅退出**: 支持Ctrl+C优雅退出

## 📊 数据流程

```
Excel文件读取 → 用户数据解析 → 系统预检查 → 批量处理
     ↓              ↓              ↓         ↓
配置文件加载 → API健康检查 → 人员状态检查 → 逐个用户处理
     ↓              ↓              ↓         ↓
日志系统初始化 → 获取用户信息 → 分配医护人员 → 提交登记
     ↓              ↓              ↓         ↓
数据文件管理 → 获取护理项目 → 更新人员计数 → 记录结果
     ↓              ↓              ↓         ↓
错误处理机制 → 构建登记数据 → 生成处理报告 → 系统完成
```

## 🔧 与原系统对比

| 特性 | 原系统 | 重构后系统 |
|------|--------|------------|
| 代码结构 | 单文件587行 | 7个模块文件 |
| 配置管理 | 硬编码 | 外部配置文件 |
| 错误处理 | 分散处理 | 统一错误处理 |
| 日志系统 | console.log | 结构化日志 |
| 代码复用 | 低 | 高 |
| 测试友好 | 困难 | 容易 |
| 维护性 | 低 | 高 |
| 扩展性 | 困难 | 容易 |
| 用户体验 | 基础 | 优秀 |

## 📈 性能优化

### 1. 内存管理
- 流式处理大文件，避免内存占用过高
- 及时释放不需要的对象引用
- 合理的数据结构选择

### 2. 网络优化
- HTTP请求超时控制
- 智能重试策略
- 错误分类处理

### 3. 处理效率
- 批量操作优化
- 异步处理提升性能
- 进度监控减少等待焦虑

## 🛠️ 开发和调试

### 开发模式
```bash
# 监听文件变化自动重启
npm run dev
```

### 调试模式
在 `config.json` 中设置：
```json
{
  "logging": {
    "level": "debug"
  }
}
```

### 查看详细日志
```bash
# 查看错误日志
type error.log

# 查看处理报告
type error_report_*.json
```

## 🚨 故障排除

### 常见问题

1. **Node.js环境问题**
   ```bash
   # 检查Node.js版本
   node --version
   
   # 应该显示 v16.0.0 或更高版本
   ```

2. **依赖安装失败**
   ```bash
   # 清理npm缓存
   npm cache clean --force
   
   # 使用国内镜像
   npm config set registry https://registry.npmmirror.com/
   
   # 重新安装
   npm install
   ```

3. **Excel文件读取失败**
   - 检查文件路径和权限
   - 确认文件格式正确（.xls 或 .xlsx）
   - 查看error.log获取详细错误信息

4. **API请求失败**
   - 检查网络连接
   - 验证config.json中的token是否有效
   - 确认API服务状态

5. **人员分配失败**
   - 检查人员数据文件完整性
   - 验证护理员名单配置
   - 查看人员统计信息

### 日志文件说明
- `error.log` - 系统错误日志
- `*_report_*.json` - 详细处理报告
- `successfulUsers.json` - 成功处理的用户列表
- `nurseObjs.json` - 护士分配统计
- `doctorObjs.json` - 医生分配统计
- `caregiverObjs.json` - 护理员分配统计

## 🔒 安全注意事项

1. **敏感信息保护**
   - 不要在代码中硬编码敏感信息
   - 定期更新API Token
   - 限制配置文件访问权限

2. **数据安全**
   - 定期备份重要数据文件
   - 确保数据传输安全
   - 遵循数据保护法规

3. **系统安全**
   - 保持Node.js和依赖包更新
   - 限制系统访问权限
   - 监控异常访问

## 📝 更新日志

### v1.0.0 (2025-09-30)
- ✨ 完全重构为模块化架构
- ✨ 新增外部配置文件支持
- ✨ 新增结构化日志系统
- ✨ 改进错误处理和重试机制
- ✨ 新增批量处理进度监控
- ✨ 新增处理结果报告导出
- ✨ 新增系统预检查功能
- ✨ 新增一键运行脚本
- 🐛 修复原系统的多个潜在问题
- 📈 提升处理性能和稳定性
- 💎 大幅提升用户体验

## 🤝 使用建议

1. **首次使用**
   - 使用`run.bat`一键运行，系统会自动检查环境
   - 确保Excel文件在正确位置
   - 查看运行日志了解处理情况

2. **日常使用**
   - 定期检查人员数据文件
   - 关注错误日志中的异常信息
   - 根据处理报告调整配置参数

3. **配置调整**
   - 修改`config.json`中的参数
   - 无需修改代码即可调整系统行为
   - 支持热重载（重启后生效）

## 📄 许可证

MIT License - 详见 LICENSE 文件

---

**注意**: 这是对原系统的完全重构，保持了所有核心功能，同时大大提升了代码质量、用户体验和维护性。建议将Excel数据文件、原有的JSON数据文件复制到此目录中使用。
